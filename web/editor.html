<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Truffle Billboard Editor</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
        <link rel="stylesheet" href="style.css">
        <style>
body {
    color: var(--text-color);
    background-color: var(--body-bg-color);
}

.editor-container {
    display: grid;
    grid-template-areas: "top top top" "frames items settings" "preview items other";
    grid-template-rows: 1fr auto auto;
    grid-template-columns: 30% 30% auto;
    gap: 0.5em;
}

.editor-item {
    padding: 0.5em;
    border-radius: 0.25em;
}

#top {
    grid-area: top;
}

#other-settings {
    grid-area: other;
}

#settings {
    grid-area: settings;
    display: flex;
    flex-flow: column;
}

#settings-content {
    flex: 1 1 auto;
}

#items {
    grid-area: items;
}

#preview {
    grid-area: preview;
}

#frames {
    grid-area: frames;
}

.editable-list {
    display: flex;
    flex-flow: column;
}

.editable-list > ol {
    flex: 1 1 auto;
    padding: 0.25em 0 0 0;
    margin: 0;
}

.editable-list > ol > li {
    margin: 0 0 0.75em 0;
    list-style-type: none;
    padding: 0.5em;
    border: 1px solid gray;
    border-radius: 0.25em;
}

.selected {
    margin: 0 0.5em 0.75em 0.5em !important;
    border: 1px solid var(--text-color) !important;
}

.editable-list li:hover, .editable-controls i:hover {
    cursor: pointer;
}

.setting:not(.hidden) {
    display: flex;
    flex-flow: row;
    margin-bottom: 0.5em;
}

.setting > input[type="text"] {
    flex: 1 0 auto;
}

input, select {
    margin-left: 0.5em;
}

#icon-help-text {
    font-size: 0.8em;
    margin-top: 0.5em;
}

#icon-help-text > p {
    margin: 0;
}
        </style>
    </head>

    <body>
        <div class="editor-container">
            <fieldset id="top" class="editor-item">
                <legend>Actions</legend>
                <div style="float: right">
                    <button style="z-index: -1;">
                        <label for="import-upload">Import</label>
                    </button>
                    <input style="display: none;" type="file" id="import-upload" name="import-upload"/>
                    <button id="export-button">Export</button>
                    <button id="save-button">Save</button>
                </div>
                <div>
                  <label for="share-input">Share Link:</label>
                  <input name="share-input" id="share-input" type="url" placeholder="https://example.com" pattern="https://.*">
                  <span> for</span>
                  <input id="share-time" type="number" min="1" value="1">
                  <span> mins</span>
                  <button id="share-button">Share</button>
                </div>
            </fieldset>
            <fieldset id="frames" class="editor-item editable-list">
                <legend>Select Frame</legend>
                <ol id="frames-content"></ol>
                <div class="editable-controls">
                    <i id="frame-new" class="fa-solid fa-plus"></i>
                    <div style="float: right;">
                        <i id="frame-up" class="fa-solid fa-chevron-up"></i>
                        <i id="frame-down" class="fa-solid fa-chevron-down"></i>
                        <span style="margin-left: 1em;"></span>
                        <i id="frame-delete" class="fa-solid fa-trash-can"></i>
                    </div>
                </div>
            </fieldset>
            <fieldset id="preview" class="editor-item">
                <legend>Preview</legend>
            </fieldset>
            <fieldset id="items" class="editor-item editable-list">
                <legend>Select Item</legend>
                <ol id="items-content"></ol>
                <div class="editable-controls">
                    <i id="item-new" class="fa-solid fa-plus"></i>
                    <div style="float: right;">
                        <i id="item-up" class="fa-solid fa-chevron-up"></i>
                        <i id="item-down" class="fa-solid fa-chevron-down"></i>
                        <span style="margin-left: 1em;"></span>
                        <i id="item-delete" class="fa-solid fa-trash-can"></i>
                    </div>
                </div>
            </fieldset>
            <fieldset id="settings" class="editor-item">
                <legend>Edit Item</legend>
                <div id="settings-content">
                    <div class="setting hidden">
                        <label for="item-type">Type:</label>
                        <select name="item-type" id="item-type">
                            <option value="text">Text</option>
                            <option value="image">Image</option>
                            <option value="icon">Icon</option>
                            <option value="text-image">Text and Image</option>
                            <option value="text-icon">Text and Icon</option>
                        </select>
                    </div>
                    <div class="setting hidden">
                        <label for="item-link">Link:</label>
                        <input type="text" name="item-link" id="item-link" placeholder="url">
                    </div>
                    <div class="setting setting-optional hidden">
                        <label for="item-text">Text:</label>
                        <input type="text" name="item-text" id="item-text" placeholder="text">
                    </div>
                    <div class="setting setting-optional hidden">
                        <label for="item-image">Image:</label>
                        <input type="text" name="item-image" id="item-image" placeholder="url">
                    </div>
                    <div class="setting setting-optional hidden">
                        <label for="item-icon">*Icon:</label>
                        <input type="text" name="item-icon" id="item-icon" placeholder="fa class"> 
                    </div> 
                    <div class="setting setting-optional hidden">
                        <label for="item-first">First:</label>
                        <select name="item-first" id="item-first">
                            <option value="text">Text</option>
                            <option value="imgicon">Image/Icon</option>
                        </select>
                    </div>
                </div>
                <p id="icon-help-text" class="hidden">
                    *Search <a href="https://fontawesome.com/search?o=r&m=free" target="_blank">fontawesome</a> icons,
                    then enter the icon's class string.
                    ex: "fa-solid fa-house" gets you <i class="fa-solid fa-house"></i>
                </p>
            </fieldset>
            <fieldset id="other-settings" class="editor-item">
                <legend>Other Settings</legend>
                <label for="interval-input">Interval:</label>
                <input type="number" name="interval-input" id="interval-input" min="1"> seconds
            </fieldset>
        </div>

        <script type="text/javascript" src="billboard.js"></script>
        <script type="text/javascript">
            let config;
            let interval;
            let groups;

            let curr = 0; // for preview
            let selectedFrame = -1;
            let selectedItem = -1; 

            const org = new URLSearchParams(window.location.search).get("org");
            if(org !== null && org !== "") {
                const socket = new WebSocket(encodeURI("ws://" + location.host + "/api?org=" + org));

                socket.addEventListener("message", function(event) {
                    const msg = JSON.parse(event.data);
                    if(msg.type == "update" && msg.config !== undefined) {
                        // notify if not admin, only the first update msg has the admin field
                        // so check if this is the first with config == undefined
                        if(config == undefined && (msg.admin == undefined || !msg.admin))
                            alert("Your session has expired, please refresh this page!");

                        config = msg.config;
                        refreshAll();
                    }
                });

                document.getElementById("save-button").addEventListener("click", function() {
                    socket.send(JSON.stringify({
                        type: "update",
                        config: config
                    }));
                });


                const shareInput = document.getElementById("share-input");
                const minsInput = document.getElementById("share-time");
                document.getElementById("share-button").addEventListener("click", function() {
                    const url = shareInput.value;
                    if(url == undefined || url == "" || !shareInput.checkValidity()) {
                        alert("Invalid link!");
                        return;
                    }

                    socket.send(JSON.stringify({
                        type: "link",
                        link: url,
                        timeout: minsInput.value * 60000
                    }));

                    shareInput.value = "";
                });
            }

            function refreshAll() {
                // clear everything
                groups = [];
                document.querySelectorAll("#preview > .bb-parent, #frames-content > li, #items-content > li").forEach(function(node) {
                    node.remove();
                });
                document.querySelectorAll(".setting, #icon-help-text").forEach(function(node) {
                    node.classList.add("hidden");
                });

                document.getElementById("interval-input").value = config.interval;

                if(config.groups.length == 0) return;

                if(curr >= config.groups.length) curr = 0;
                if(selectedFrame >= config.groups.length) selectedFrame = config.groups.length - 1;
                if(selectedFrame == -1 && config.groups.length > 0) selectedFrame = 0;

                for(let i = 0; i < config.groups.length; i++) {
                    const group = createBillboardGroup(config.groups[i]);

                    const li = document.createElement("li");
                    li.appendChild(group.cloneNode(true));
                    li.addEventListener("click", function() {
                        selectedFrame = i;
                        document.querySelectorAll("#frames-content > .selected").forEach(function(node) {
                            node.classList.remove("selected");
                        });
                        li.classList.add("selected");

                        refreshItems();
                    });
                    if(i == selectedFrame) li.classList.add("selected");

                    const frames = document.getElementById("frames-content")
                    frames.appendChild(li);
                    
                    group.classList.add("hidden");
                    groups.push(group);
                    document.getElementById("preview").appendChild(group);
                }

                groups[curr].classList.remove("hidden");

                refreshItems();
                refreshInterval();
            }

            function refreshInterval() {
                if(interval !== undefined) clearInterval(interval);
                interval = setInterval(function() {
                    if(groups.length == 0) return;

                    document.querySelector("#preview > .bb-parent:not(.hidden)").classList.add("hidden");

                    const group = groups[++curr % groups.length];
                    group.classList.remove("hidden");

                }, (config.interval == undefined ? 30 : config.interval) * 1000);
            }

            function refreshFrame() {
                if(selectedFrame == -1) return;

                const group = createBillboardGroup(config.groups[selectedFrame]);

                document.querySelectorAll("#frames-content > li > .bb-parent")[selectedFrame].replaceWith(group.cloneNode(true)); 

                if(curr % groups.length !== selectedFrame) group.classList.add("hidden");
                groups[selectedFrame].replaceWith(group);
                groups[selectedFrame] = group;

                refreshItems();
            }

            function refreshItems() {
                document.querySelectorAll("#items-content > li").forEach(function(node) {
                    node.remove();
                });
                document.querySelectorAll(".setting, #icon-help-text").forEach(function(node) {
                    node.classList.add("hidden");
                });

                if(selectedFrame == -1) return;

                const items = config.groups[selectedFrame];
                if(selectedItem >= items.length) selectedItem = items.length - 1;
                if(selectedItem == -1 && items.length > 0) selectedItem = 0;

                for(let i = 0; i < items.length; i++) {
                    const item = items[i];

                    const li = document.createElement("li");
                    li.addEventListener("click", function() {
                        selectedItem = i;
                        document.querySelectorAll("#items-content > .selected").forEach(function(node) {
                            node.classList.remove("selected");
                        });
                        li.classList.add("selected");

                        refreshSettings();
                    });
                    if(i == selectedItem) li.classList.add("selected");

                    const parent = document.createElement("div");
                    parent.classList.add("bb-group");
                    parent.classList.add("bb-parent");

                    const hasLink = item.link !== undefined && item.link != "";
                    const container = hasLink ? document.createElement("a") : parent;
                    if(hasLink) {
                        container.href = item.link;
                        container.target = "_blank";
                    }

                    container.classList.add("bb-group");

                    createBillboardItems(item).forEach(item => container.appendChild(item));

                    if(hasLink) parent.appendChild(container);
                    li.appendChild(parent);
                    document.getElementById("items-content").appendChild(li);
                }

                refreshSettings();
            }

            function refreshSettings() {
                // make sure all settings are hidden when no item is selected (checked after all hidden)
                document.querySelectorAll(".settting, #icon-help-text").forEach(function(node) {
                    node.classList.add("hidden");
                });

                if(selectedFrame == -1 || selectedItem == -1) return;

                document.querySelectorAll(".setting:not(.setting-optional)").forEach(function(node) {
                    node.classList.remove("hidden");
                });

                const item = config.groups[selectedFrame][selectedItem];

                document.getElementById("item-type").value = item.type == "both" ? (item.icon == undefined ? "text-image" : "text-icon") : item.type;
                document.getElementById("item-link").value = item.link;
                
                refreshSettingInput("item-text", item.text);
                refreshSettingInput("item-image", item.image);
                refreshSettingInput("item-icon", item.icon);
                if(item.type == "both") refreshSettingInput("item-first", item.first == undefined ? "imgicon" : item.first);

                if(item.icon !== undefined) document.getElementById("icon-help-text").classList.remove("hidden");
            }

            function refreshSettingInput(name, value) {
                const elem = document.getElementById(name);
                if(value !== undefined) {
                    elem.value = value;
                    elem.parentNode.classList.remove("hidden");
                } else elem.parentNode.classList.add("hidden");
            }

            document.getElementById("frame-new").addEventListener("click", function() {
                config.groups.push([]);
                selectedFrame = config.groups.length - 1;
                refreshAll();
            });

            document.getElementById("frame-up").addEventListener("click", function() {
                if(selectedFrame == -1) return;
                config.groups.swapItems(selectedFrame, --selectedFrame);
                refreshAll();
            });

            document.getElementById("frame-down").addEventListener("click", function() {
                if(selectedFrame >= config.groups.length - 1) return;
                config.groups.swapItems(selectedFrame, ++selectedFrame);
                refreshAll();
            });

            document.getElementById("frame-delete").addEventListener("click", function() {
                config.groups.splice(selectedFrame, 1);
                refreshAll();
            });

            document.getElementById("item-new").addEventListener("click", function() {
                if(selectedFrame == -1) return;
                config.groups[selectedFrame].push({
                    "type": "text",
                    "link": "",
                    "text": ""
                });
                selectedItem = config.groups[selectedFrame].length - 1;
                refreshFrame();
            });

            document.getElementById("item-up").addEventListener("click", function() {
                if(selectedFrame == -1 || selectedItem == 0) return;
                config.groups[selectedFrame].swapItems(selectedItem, --selectedItem);
                refreshFrame();
            });

            document.getElementById("item-down").addEventListener("click", function() {
                if(selectedFrame == -1 || selectedItem == config.groups[selectedFrame].length - 1) return;
                config.groups[selectedFrame].swapItems(selectedItem, ++selectedItem);
                refreshFrame();
            });

            document.getElementById("item-delete").addEventListener("click", function() {
                if(selectedFrame == -1 || selectedItem == -1) return;
                config.groups[selectedFrame].splice(selectedItem, 1);
                refreshFrame();
            });

            Array.prototype.swapItems = function(a, b){
                this[a] = this.splice(b, 1, this[a])[0];
                return this;
            }

            document.getElementById("item-type").addEventListener("input", function() {
                if(selectedFrame == -1 || selectedItem == -1) return;
                let item = config.groups[selectedFrame][selectedItem];

                // kinda a hack, but the text & image/icon options both have a - in the name
                item.type = this.value.indexOf('-') > -1 ? "both" : this.value;

                if(this.value.includes("text")) {
                    if(item.text == undefined) item.text = "";
                    if(item.first == undefined) item.first = "text";

                    if(this.value == "text-image") {
                        if(item.image == undefined) item.image = "";
                        item.icon = undefined;
                    } else if(this.value == "text-icon") {
                        if(item.icon == undefined) item.icon = "";
                        item.image = undefined;
                    } else {
                        item.image = undefined;
                        item.icon = undefined; 
                        item.first = undefined;
                    }
                } else {
                    if(this.value == "image") {
                        if(item.image == undefined) item.image = "";
                        item.icon = undefined;
                    } else if(this.value == "icon") {
                        if(item.icon == undefined) item.icon = "";
                        item.image = undefined;
                    }

                    item.text = undefined;
                    item.first = undefined;
                }

                refreshFrame();
            });

            document.getElementById("item-link").addEventListener("input", function() {
                if(selectedFrame == -1 || selectedItem == -1) return;
                config.groups[selectedFrame][selectedItem].link = this.value;
                refreshFrame();
            });

            document.getElementById("item-text").addEventListener("input", function() {
                if(selectedFrame == -1 || selectedItem == -1) return;
                config.groups[selectedFrame][selectedItem].text = this.value;
                refreshFrame();
            });

            let typingTimeout; // we will delay a bit so that typing doesn't spam http requests
            document.getElementById("item-image").addEventListener("input", function() {
                if(selectedFrame == -1 || selectedItem == -1) return;
                if(typingTimeout !== undefined) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(function() {
                    config.groups[selectedFrame][selectedItem].image = document.getElementById("item-image").value;
                    refreshFrame();
                }, 500);
            });

            document.getElementById("item-icon").addEventListener("input", function() {
                if(selectedFrame == -1 || selectedItem == -1) return;
                config.groups[selectedFrame][selectedItem].icon = this.value;
                refreshFrame();
            });

            document.getElementById("item-first").addEventListener("input", function() {
                if(selectedFrame == -1 || selectedItem == -1) return;
                config.groups[selectedFrame][selectedItem].first = this.value;
                refreshFrame();
            });

            document.getElementById("interval-input").addEventListener("input", function() {
                if(this.value < 1) this.value = 1;
                config.interval = this.value;
                refreshInterval();
            });

            // Function to download data to a file
            // https://stackoverflow.com/a/30832210
            function download(data, filename, type) {
                const file = new Blob([data], {type: type});
                if (window.navigator.msSaveOrOpenBlob) // IE10+
                    window.navigator.msSaveOrOpenBlob(file, filename);
                else { // Others
                    var a = document.createElement("a"),
                            url = URL.createObjectURL(file);
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(function() {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);  
                    }, 0); 
                }
            }
            
            document.getElementById("export-button").addEventListener("click", function() {
                download(JSON.stringify(config, null, 2), "billboard.json", "application/json");
            });

            const importReader = new FileReader();
            importReader.addEventListener("load", function() {
                const json = JSON.parse(importReader.result);
                config = json;
                refreshAll();
            });

            document.getElementById("import-upload").addEventListener("change", function() {
                const file = this.files[0];
                if(file && file.type !== "application/json") return;

                importReader.readAsText(file);
            });
        </script>
    </body>
</html>
